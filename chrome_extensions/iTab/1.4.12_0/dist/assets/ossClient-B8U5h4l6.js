import{a as t,d as e}from"./localforage-BVRgvwJc.js";import{apiGetSts as n}from"./baseApi-BUYbzNW3.js";import r from"./indexdb-D6yYQ1E4.js";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var o=function(){return o=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},o.apply(this,arguments)};function s(t){return t.replace(/^\/+/,"")}function a(t){return unescape(encodeURIComponent(t))}function i(t,e){var n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}function c(t,e){return t<<e|t>>>32-e}function u(t,e){for(var n,r=e?"0123456789ABCDEF":"0123456789abcdef",o="",s=0,a=t.length;s<a;s+=1)n=t.charCodeAt(s),o+=r.charAt(n>>>4&15)+r.charAt(15&n);return o}function h(t){var e,n=32*t.length,r="";for(e=0;e<n;e+=8)r+=String.fromCharCode(t[e>>5]>>>24-e%32&255);return r}function f(t){var e,n=8*t.length,r=Array(t.length>>2),o=r.length;for(e=0;e<o;e+=1)r[e]=0;for(e=0;e<n;e+=8)r[e>>5]|=(255&t.charCodeAt(e/8))<<24-e%32;return r}function p(t,e){var n,r,o,s,a,i,c,u,h=e.length,f=Array();for(s=(i=Array(Math.ceil(t.length/2))).length,n=0;n<s;n+=1)i[n]=t.charCodeAt(2*n)<<8|t.charCodeAt(2*n+1);for(;i.length>0;){for(a=Array(),o=0,n=0;n<i.length;n+=1)o=(o<<16)+i[n],o-=(r=Math.floor(o/h))*h,(a.length>0||r>0)&&(a[a.length]=r);f[f.length]=o,i=a}for(c="",n=f.length-1;n>=0;n--)c+=e.charAt(f[n]);for(u=Math.ceil(8*t.length/(Math.log(e.length)/Math.log(2))),n=c.length;n<u;n+=1)c=e[0]+c;return c}function l(t,e){void 0===e&&(e="=");var n,r,o,s="",a=t.length;for(n=0;n<a;n+=3)for(o=t.charCodeAt(n)<<16|(n+1<a?t.charCodeAt(n+1)<<8:0)|(n+2<a?t.charCodeAt(n+2):0),r=0;r<4;r+=1)8*n+6*r>8*t.length?s+=e:s+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(o>>>6*(3-r)&63);return s}function d(t){var e=t.responseText||t.response;if(!e)return e;try{return JSON.parse(e)}catch(n){return e}}function g(t,e){var n=new XMLHttpRequest;n.timeout=e.timeout||6e4,e.onProgress&&n.upload&&(n.upload.onprogress=function(t){t.percent=t.loaded/t.total*100,e.onProgress(t)}),n.onerror=function(t){e.onError(t)},n.onload=function(){if(n.status<200||n.status>=300)return e.onError(function(t,e,n){var r=n.response.match(/<Code>(.+)<\/Code>/),o=n.response.match(/<Message>(.+)<\/Message>/),s=e.method||"GET",a="";r&&r[1]&&(a+=r[1]+": "),o&&o[1]&&(a+=o[1]);var i=new Error(a);return i.status=n.status,i.method=s,i.code=r&&r[1]||"",i.url=t,i}(t,e,n),d(n));var r={status:n.status,statusText:n.statusText,xhr:n,data:d(n)};e.onSuccess(r,n)},n.ontimeout=function(t){var r=new Error("Request timeout, limit "+n.timeout+" ms.");e.onError(r)},e.onAbort&&(n.onabort=e.onAbort),n.open(e.method||"get",t,!0),e.withCredentials&&"withCredentials"in n&&(n.withCredentials=!0);var r=e.headers||{};for(var o in null!==r["X-Requested-With"]&&n.setRequestHeader("X-Requested-With","XMLHttpRequest"),r)r.hasOwnProperty(o)&&null!==r[o]&&n.setRequestHeader(o,r[o]);return n.send(e.data||null),{abort:function(){n.abort()}}}var y=function(t){var e=!(!t||"boolean"!=typeof t.uppercase)&&t.uppercase,n=t&&"string"==typeof t.pad?t.pad:"=",r=!t||"boolean"!=typeof t.utf8||t.utf8;function o(t,e){var n,r,o,s,a,u,h,f,p=Array(80),l=1732584193,d=-271733879,v=-1732584194,m=271733878,b=-1009589776;for(t[e>>5]|=128<<24-e%32,t[15+(e+64>>9<<4)]=e,n=0;n<t.length;n+=16){for(s=l,a=d,u=v,h=m,f=b,r=0;r<80;r+=1)p[r]=r<16?t[n+r]:c(p[r-3]^p[r-8]^p[r-14]^p[r-16],1),o=i(i(c(l,5),g(r,d,v,m)),i(i(b,p[r]),y(r))),b=m,m=v,v=c(d,30),d=l,l=o;l=i(l,s),d=i(d,a),v=i(v,u),m=i(m,h),b=i(b,f)}return Array(l,d,v,m,b)}function s(t,e){return h(o(f(t=e?a(t):t),8*t.length))}function d(t,e){var n,s,i,c,u;for(t=r?a(t):t,e=r?a(e):e,(n=f(t)).length>16&&(n=o(n,8*t.length)),s=Array(16),i=Array(16),c=0;c<16;c+=1)s[c]=909522486^n[c],i[c]=1549556828^n[c];return u=o(s.concat(f(e)),512+8*e.length),h(o(i.concat(u),672))}function g(t,e,n,r){return t<20?e&n|~e&r:t<40?e^n^r:t<60?e&n|e&r|n&r:e^n^r}function y(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}this.hex=function(t){return u(s(t,r),e)},this.b64=function(t){return l(s(t,r),n)},this.any=function(t,e){return p(s(t,r),e)},this.raw=function(t){return s(t,r)},this.hex_hmac=function(t,e){return u(d(t,e))},this.b64_hmac=function(t,e){return l(d(t,e),n)},this.any_hmac=function(t,e,n){return p(d(t,e),n)},this.setUpperCase=function(t){return"boolean"==typeof t&&(e=t),this},this.setPad=function(t){return n=t||n,this},this.setUTF8=function(t){return"boolean"==typeof t&&(r=t),this}};const v=t(function(){function t(e){if(!(this instanceof t))return new t(e);var n=o(o({endpoint:null,region:"oss-cn-hangzhou",timeout:3e5,internal:!1,secure:void 0},e),{host:""});if(n.endpoint);else{if(!n.region||!n.bucket)throw new Error("require endpoint or region/bucket in options");n.endpoint=n.bucket,n.internal&&(n.region+="-internal"),n.endpoint+="."+n.region+".aliyuncs.com"}n.host+="http"+(!0===n.secure||location&&"https:"===location.protocol?"s":"")+"://"+n.endpoint,this.opts=n}return t.prototype.postObject=function(t,e,n){var r;void 0===n&&(n={});var i=new FormData;Object.keys(n.headers||{}).forEach((function(t){i.append(t,n.headers[t].toString())}));var c,u,h=s((n.dir||"").replace(/^(.+?)\/*$/,"$1/")+s(t));if(i.append("key",h),this.opts.accessKeyId&&this.opts.accessKeySecret){if("string"==typeof n.policy)r=n.policy;else{var f=o({expiration:new Date(+new Date+864e5).toISOString(),conditions:[{bucket:this.opts.bucket},{key:h},["content-length-range",0,1073741824]]},n.policy);r=l(a(JSON.stringify(f)))}var p=n.signature||(c=this.opts.accessKeySecret,u=r,(new y).b64_hmac(c,u));i.append("OSSAccessKeyId",this.opts.accessKeyId),i.append("policy",r),i.append("Signature",p),this.opts.stsToken&&i.append("x-oss-security-token",this.opts.stsToken)}var d=function(t,e){void 0===e&&(e=[]);var n={};return Object.keys(t).forEach((function(r){var o=r.toLowerCase();(/^x-oss-/.test(o)||e.indexOf(r)>-1)&&(n[o]=t[r])})),n}(n,["success_action_status","success_action_redirect"]);Object.keys(d).forEach((function(t){return i.append(t,d[t])})),i.append("file",e);var v=function(){},m=n.onSuccess||v,b={method:"POST",data:i,timeout:n.timeout||this.opts.timeout,onSuccess:function(t,e){return m(t,e)},onError:n.onError||function(t){},onAbort:n.onAbort||v};return n.onProgress&&(b.onProgress=n.onProgress),g(this.opts.host,b)},t.prototype.generateObjectUrl=function(t,e){return e?"/"!==e[e.length-1]&&(e+="/"):e=this.opts.host+"/",e+function(t){return encodeURIComponent(t).replace(/%2F/g,"/")}(s(t))},t}()),m="ali-sts",b=async t=>{let o=await r.get(m);return o&&!e(o.Expiration).isBefore(e())||(o=(await n()).data,r.set(m,o)),new Promise(((e,n)=>{new v({region:"oss-cn-shenzhen",bucket:"xdlumia2",accessKeyId:o.AccessKeyId,accessKeySecret:o.AccessKeySecret,stsToken:o.SecurityToken}).postObject(t.path,t.file,{onSuccess:()=>{let n=`https://files.codelife.cc/${t.path}`;e(n)},onError:()=>{n()}})}))};export{b as o};
